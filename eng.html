<!doctype html>
<meta charset="utf-8">
<title>LD2410 Engineering</title>
<style>
  :root { --bg:#0f1317; --fg:#d8dee9; --mut:#9fb2c8; --panel:#161b22; --line:#2a2f37; }
  body { margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  header { display:flex; align-items:center; gap:16px; padding:12px 16px; border-bottom:1px solid var(--line); }
  header h1 { font-size:18px; margin:0; color:#aec6ff; }
  a { color:#fff; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:12px; }
  .card { background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px; }
  .card h2 { margin:0 0 8px 0; font-size:16px; }
  .big { font-size:28px; font-weight:600; }
  .mut { color:var(--mut); }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  canvas { width:100%; height:120px; display:block; background:linear-gradient(#0e1419,#0b1015); border-radius:6px; border:1px solid var(--line); }
  .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px; align-items:center; }
  input[type="number"], textarea { width:100%; background:#0b1015; color:var(--fg); border:1px solid var(--line); border-radius:6px; padding:6px; }
  textarea { height:74px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; }
  button { padding:8px 10px; background:#1f6feb; color:#fff; border:0; border-radius:8px; cursor:pointer; }
  button:disabled { background:#3a507e; cursor:not-allowed; }
  .port { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:#ff9c9c; vertical-align:middle; margin-left:6px;}
  .dot.ok { background:#87e887; }
  .macro-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
  .small { font-size:12px; }
  @media (max-width: 980px) { .row { grid-template-columns: 1fr; } }
</style>

<header>
  <h1>LD2410 Engineering</h1>
  <div class="mut small">Polls <code>/engdata</code> every 500 ms</div>
  <div style="margin-left:auto"><a href="/">⬅ Back to main</a></div>
</header>

<div class="row">
  <div class="card" id="cardA">
    <h2>A (<span id="A_port" class="port">/dev/ttyUSB0</span><span id="A_open" class="dot"></span>)</h2>
    <div class="big"><span id="A_dist">—</span> <span class="mut">cm</span></div>
    <div class="grid2" style="margin-top:8px">
      <div><div class="mut small">Moving energy</div><canvas id="A_me"></canvas></div>
      <div><div class="mut small">Still energy</div><canvas id="A_se"></canvas></div>
    </div>
    <div style="margin-top:8px">
      <div class="mut small">Moving distance (history)</div>
      <canvas id="A_md"></canvas>
    </div>
  </div>

  <div class="card" id="cardB">
    <h2>B (<span id="B_port" class="port">/dev/ttyUSB1</span><span id="B_open" class="dot"></span>)</h2>
    <div class="big"><span id="B_dist">—</span> <span class="mut">cm</span></div>
    <div class="grid2" style="margin-top:8px">
      <div><div class="mut small">Moving energy</div><canvas id="B_me"></canvas></div>
      <div><div class="mut small">Still energy</div><canvas id="B_se"></canvas></div>
    </div>
    <div style="margin-top:8px">
      <div class="mut small">Moving distance (history)</div>
      <canvas id="B_md"></canvas>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h2>Macros (hex frames)</h2>
    <div class="macro-grid">
      <div>
        <div class="mut small">Enter Config</div>
        <textarea id="m_enter" placeholder="FD FC FB FA ... 04 03 02 01"></textarea>
      </div>
      <div>
        <div class="mut small">Set Range / No-one delay</div>
        <textarea id="m_range" placeholder="FD FC FB FA ... 04 03 02 01"></textarea>
      </div>
      <div>
        <div class="mut small">Exit Config</div>
        <textarea id="m_exit" placeholder="FD FC FB FA ... 04 03 02 01"></textarea>
      </div>
    </div>
    <div class="kv" style="margin-top:10px">
      <div>Side</div>
      <div>
        <label><input type="radio" name="side" value="A" checked> A</label>
        &nbsp; <label><input type="radio" name="side" value="B"> B</label>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:10px">
      <button id="btn_save">Save macros</button>
      <button id="btn_enter">Run: Enter</button>
      <button id="btn_range">Run: Range/Delay</button>
      <button id="btn_exit">Run: Exit</button>
      <div class="mut small" id="macro_status"></div>
    </div>
    <div class="mut small" style="margin-top:6px">Tip: put one hex frame per line. We send them in order and show RX for each.</div>
  </div>

  <div class="card">
    <h2>Sampler config</h2>
    <div class="kv">
      <div>EMA α (0.05–0.40)</div>
      <input type="number" id="alpha" step="0.01" min="0.05" max="0.40">
    </div>
    <div class="kv" style="margin-top:8px">
      <div>Min energy (ignore below)</div>
      <input type="number" id="min_energy" step="1" min="0" max="100">
    </div>
    <div style="margin-top:10px">
      <button id="btn_apply">Apply</button>
      <span class="mut small" id="apply_status"></span>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  function dot(el, ok){ el.classList.toggle('ok', !!ok); }
  function getSide(){ return document.querySelector('input[name="side"]:checked').value; }

  function drawSpark(canvas, arr, maxY){
    const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.clientWidth;
    const H = canvas.height = canvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#7aa2ff';
    ctx.beginPath();
    let started = false;
    const n = arr.length;
    for (let i=0;i<n;i++){
      const x = i*(W/(Math.max(1,n-1)));
      const v = arr[i];
      if (v===null || v===undefined){ started=false; continue; }
      const y = H - (Math.max(0,Math.min(maxY,v))/maxY)*H;
      if (!started){ ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
    }
    ctx.stroke();
  }

  async function loadMacros(){
    const r = await fetch('/engmacros'); const j = await r.json();
    const m = j.macros || {};
    $('m_enter').value = (m.enter_config||[]).join('\n');
    $('m_range').value = (m.set_range_delay||[]).join('\n');
    $('m_exit').value  = (m.exit_config||[]).join('\n');
  }
  async function saveMacros(){
    const payload = {
      macros: {
        enter_config: ($('m_enter').value||'').split(/\n+/).filter(Boolean),
        set_range_delay: ($('m_range').value||'').split(/\n+/).filter(Boolean),
        exit_config: ($('m_exit').value||'').split(/\n+/).filter(Boolean),
      }
    };
    const r = await fetch('/engmacros',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const j = await r.json();
    $('macro_status').textContent = j.ok ? 'Saved' : ('Error: '+(j.error||''));
    setTimeout(()=> $('macro_status').textContent='', 1200);
  }
  async function runMacro(name){
    const side = getSide();
    const r = await fetch('/eng/run_macro',{method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({side, name})});
    const j = await r.json();
    $('macro_status').textContent = j.ok ? ('Sent '+(j.results||[]).length+' frame(s) to '+side) : ('Error: '+(j.error||'')); 
    setTimeout(()=> $('macro_status').textContent='', 1800);
  }
  $('btn_save').onclick = saveMacros;
  $('btn_enter').onclick = ()=>runMacro('enter_config');
  $('btn_range').onclick = ()=>runMacro('set_range_delay');
  $('btn_exit').onclick  = ()=>runMacro('exit_config');

  async function applySampler(){
    const r = await fetch('/state'); const cfg = (await r.json()).state || {};
    const alpha = parseFloat($('alpha').value);
    const minE  = parseInt($('min_energy').value,10);
    cfg.ld_alpha = Math.max(0.05, Math.min(0.40, alpha||0.15));
    cfg.min_energy = Math.max(0, Math.min(100, isNaN(minE)?5:minE));
    await fetch('/state',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cfg)});
    $('apply_status').textContent = 'Applied';
    setTimeout(()=> $('apply_status').textContent='', 1200);
  }
  $('btn_apply').onclick = applySampler;

  async function tick(){
    try{
      const r = await fetch('/engdata?ts='+Date.now(), {cache:'no-store'});
      const j = await r.json(); if (!j.ok) throw new Error('bad');
      const A=j.A, B=j.B;

      $('A_port').textContent = j.cfg.ports.A.port || '—';
      $('B_port').textContent = j.cfg.ports.B.port || '—';
      dot($('A_open'), j.cfg.ports.A.open); dot($('B_open'), j.cfg.ports.B.open);

      $('A_dist').textContent = (A.now.move_dist ?? '—');
      $('B_dist').textContent = (B.now.move_dist ?? '—');

      drawSpark($('A_me'), A.hist.me, 100);
      drawSpark($('A_se'), A.hist.se, 100);
      drawSpark($('A_md'), A.hist.md.map(v=>v==null?null:(v/60)), (600/60));

      drawSpark($('B_me'), B.hist.me, 100);
      drawSpark($('B_se'), B.hist.se, 100);
      drawSpark($('B_md'), B.hist.md.map(v=>v==null?null:(v/60)), (600/60));

      if (!$('alpha').value) $('alpha').value = j.cfg.alpha;
      if (!$('min_energy').value) $('min_energy').value = j.cfg.min_energy;
    }catch(e){}
    finally{
      setTimeout(tick, 500);
    }
  }
  loadMacros().then(tick);
})();
</script>
